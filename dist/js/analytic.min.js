/*
 server 2016-12-08 
*/
function setNextStepMessage(a){$("#next-step-message").empty();var b=" "+a;$("#next-step-message").append(b),nextStepBlinking("#next-step-message")}function nextStepBlinking(a){$(a).animate({opacity:.4},1e3,"linear",function(){$(this).animate({opacity:1},1e3,"linear",function(){$(this).animate({opacity:.4},1e3,"linear",function(){$(this).animate({opacity:1},1e3,"linear",function(){$(this).animate({opacity:.4},1e3,"linear",function(){$(this).animate({opacity:1},1e3)})})})})})}function setTopMessage(a,b){var c={timeout:5e3};box_message_on_map=L.control.messagebox(c).addTo(map),box_message_on_map.show(a,5e3,b)}function enableNextAndAddButtons(){$("#add-label-to-trajectory").hasClass("btn-danger")&&$("#add-label-to-trajectory").toggleClass("btn-danger btn-success"),$("#add-label-to-trajectory").prop("disabled",!1),$("#next-trajectory").hasClass("btn-danger")&&$("#next-trajectory").toggleClass("btn-danger btn-success"),$("#next-trajectory").prop("disabled",!1)}function disableNextAndAddButtons(){$("#add-label-to-trajectory").hasClass("btn-success")&&$("#add-label-to-trajectory").toggleClass("btn-danger btn-success"),$("#add-label-to-trajectory").prop("disabled",!0),$("#next-trajectory").hasClass("btn-success")&&$("#next-trajectory").toggleClass("btn-danger btn-success"),$("#next-trajectory").prop("disabled",!0)}function enableRunButton(){$("#run-button").hasClass("btn-danger")&&$("#run-button").toggleClass("btn-danger btn-success"),$("#run-button").prop("disabled",!1)}function disableRunButton(){$("#run-button").hasClass("btn-success")&&$("#run-button").toggleClass("btn-danger btn-success"),$("#run-button").prop("disabled",!0)}function classifyAllData(a){showLoadingAnimation(),$.post(web_server_address+"/classify_all",a,function(a,b){a=JSON.parse(a);var c=0,d=0;for(key in a)d%100==0&&c++,"undefined"==typeof bag_of_trajectories["bag_"+c]&&(bag_of_trajectories["bag_"+c]={}),bag_of_trajectories["bag_"+c][key]=a[key],d++;clearAllLayers(),disableRunButton(),addBagsToSummary()})}function createBagComponents(){var a="<dl id='bag-component' class=\"dl-no-margin\">Bag: <select name='bag-selector' id='bag-selector'></select></dl>";$("#labels-distribution-body").prepend(a)}function addBagsToSummary(){createBagComponents(),$("#bag-selector").empty();for(bag in bag_of_trajectories)$("#bag-selector").append("<option val='"+bag+"'>"+bag+"</option>");$("#bag-selector").change(function(){var a=$("#bag-selector option:selected").text(),b={};b.dataset=dataset,b.bag=bag_of_trajectories[a],showLoadingAnimation(),$.post(web_server_address+"/trajectories_geojson",JSON.stringify(b),function(a,b){clearAllLayers();var c=a.split("\n");trajectories_map=[],c.forEach(function(a,b,c){if(a){var d=JSON.parse(a);trajectories_map[d.tid]=createGeojsonTrajectory(d,line_layer_default_style),trajectories_map[d.tid].label=d.label}}),updateSummary(),setNextStepMessage("All trajectories were succesfully classified. Please select a bag to visualize the results."),refreshLayers(),createResultsCharts(),$("#results-nav").show(),hideLoadingAnimation(),updateMapBounds()})}),$("#bag-selector").change()}function clearUnlabeledTrajectories(){for(var a in trajectories_map){var b=trajectories_map[a].label;"unlabeled"==b&&delete trajectories_map[a]}}function runActiveLearning(a){showLoadingAnimation(),$.post(web_server_address+"/al_run",a,function(a,b){var c=a.split("\n");group_unlabeled_geojson_trajectories.clearLayers(),delete window.group_unlabeled_geojson_trajectories,delete window.unlabeled_leaflet_geojson_trajectories,unlabeled_items_key=[],clearUnlabeledTrajectories(),c.forEach(function(a,b,c){if(a){var d=JSON.parse(a);trajectories_map[d.tid]=createGeojsonTrajectory(d,line_layer_default_style),trajectories_map[d.tid].label="unlabeled",unlabeled_items_key.push(d.tid)}}),refreshLayers(),updateSummary(),hideLoadingAnimation(),setNextStepMessage("Please provide a label to each trajectory remaining (in red) on the map."),disableRunButton(),enableNextAndAddButtons(),previous_remaining_from_budget=parseInt($("#remaining-budget").text()),updateMapBounds()})}function updateSummary(){var a=parseInt($("#nof-trajectories").text())-parseInt($("#total-labeled").text());$("#remaining").text(a);var b=parseInt($("#total-budget").val())-parseInt($("#total-labeled").text());$("#remaining-budget").text(b)}function convertObjectMapToArray(a){var b=[];for(var c in a)b.push(a[c]);return b}function rotate(a,b){for(;b--;){var c=a.shift();a.push(c)}return a}function createResultsCharts(){var a={},b={},c=[],d=[],e=[],f=[],g=($("#middle-left-nav").css("height").replace("px",""),$("#middle-left-nav").css("width").replace("px",""),400),h=200;for(var i in trajectories_map){var j=trajectories_map[i].label;if("unlabeled"!=j){var k=trajectories_map[i]._layers;c.hasOwnProperty(j)||(c[j]=[]),c[j].push(trajectories_map[i]);for(var l in k)if("undefined"==typeof a[j]&&(a[j]={},b[j]={}),k.hasOwnProperty(l)){var m=k[l].feature;for(var n in m.properties)m.properties.hasOwnProperty(n)&&("undefined"==typeof d[n]&&(d[n]=n),"undefined"==typeof a[j][i]&&(a[j][i]={}),"undefined"==typeof a[j][n]&&(a[j][i][n]={}),a[j][i][n]=m.properties[n]);for(point_feat_name in m.points)"undefined"==typeof e[point_feat_name]&&(e[point_feat_name]=point_feat_name),"undefined"==typeof b[j][point_feat_name]&&(b[j][point_feat_name]=[]),b[j][point_feat_name].push(m.points[point_feat_name])}}}for(var o in c)f[o]=c[o].length;$("#trajectory-feature-selector").empty();for(n in d)$("#trajectory-feature-selector").append("<option val='"+n+"'>"+n+"</option>");$("#result-point-feature-selector").empty();for(p in e)$("#result-point-feature-selector").append("<option val='"+p+"'>"+p+"</option>");var n=$("#trajectory-feature-selector option:selected").text();$("#trajectory-feature-selector").unbind(),$("#trajectory-feature-selector").change(function(){var b=$("#trajectory-feature-selector option:selected").text();$("#trajectory-features-distribution-chart").empty(),google.charts.setOnLoadCallback(drawHistogramTrajectoryFeaturesDistribution(a,b,g,h))});var p=$("#result-point-feature-selector option:selected").text();$("#result-point-feature-selector").unbind(),$("#result-point-feature-selector").change(function(){var a=$("#result-point-feature-selector option:selected").text();$("#point-features-distribution-chart").empty(),google.charts.setOnLoadCallback(drawHistogramPointFeaturesDistribution(b,a,g,h))}),google.charts.setOnLoadCallback(drawHistogramTrajectoryFeaturesDistribution(a,n,g,h)),google.charts.setOnLoadCallback(drawHistogramPointFeaturesDistribution(b,p,g,h)),google.charts.setOnLoadCallback(drawStackedLabelsDistribution(f,g,h+17))}function drawHistogramPointFeaturesDistribution(a,b,c,d){var e=[],f=[],g={},h=0,i=[];for(label in a)if(a.hasOwnProperty(label)){f.push(label),g[label]=h;var j=$("#color-"+label).val();i.push(j),h++}e.push(f);var k=!1;for(label in a)if(a.hasOwnProperty(label))for(var l in a[label][b]){for(var m=[],n=0;n<h;n++)m.push(null);var o=parseFloat(a[label][b][l]);o>1e3&&(k=!0),m[g[label]]=trunc(o),e.push(m)}var p=google.visualization.arrayToDataTable(e),q={height:200,titleTextStyle:{fontSize:16,bold:!0},legend:{position:"none"},colors:i,interpolateNulls:!1,isStacked:!0,hAxis:{},vAxis:{title:"Number of items",viewWindowMode:"explicit",viewWindow:{min:0}},histogram:{hideBucketItems:!0}};k&&(q.hAxis.textStyle={},q.hAxis.textStyle.fontSize=8,q.hAxis.slantedText=!0,q.hAxis.slantedTextAngle=90);var r=new google.visualization.Histogram(document.getElementById("point-features-distribution-chart"));r.draw(p,q)}function drawHistogramTrajectoryFeaturesDistribution(a,b,c,d){var e=[],f=[],g={},h=0,i=[];for(label in a)if(a.hasOwnProperty(label)){f.push(label),g[label]=h;var j=$("#color-"+label).val();i.push(j),h++}e.push(f);var k=!1;for(label in a)if(a.hasOwnProperty(label))for(tid in a[label]){for(var l=[],m=0;m<h;m++)l.push(null);var n=parseFloat(a[label][tid][b]);n>1e3&&(k=!0),l[g[label]]=trunc(n),e.push(l)}var o=google.visualization.arrayToDataTable(e),p={height:200,titleTextStyle:{fontSize:16,bold:!0},legend:{position:"none"},colors:i,interpolateNulls:!1,isStacked:!0,hAxis:{},vAxis:{title:"Number of items",viewWindowMode:"explicit",viewWindow:{min:0}},histogram:{hideBucketItems:!0}};k&&(p.hAxis.textStyle={},p.hAxis.textStyle.fontSize=8,p.hAxis.slantedText=!0,p.hAxis.slantedTextAngle=90);var q=new google.visualization.Histogram(document.getElementById("trajectory-features-distribution-chart"));q.draw(o,p)}function drawStackedLabelsDistribution(a,b,c){var d=[];d.push(["Label","Number of trajectories",{role:"style"}]);for(key in a){var e=$("#color-"+key).val();d.push([key,a[key],e])}var f=google.visualization.arrayToDataTable(d),g={height:200,titleTextStyle:{fontSize:16,bold:!0},legend:{position:"none"},hAxis:{},vAxis:{title:"Number of trajectories",viewWindowMode:"explicit",viewWindow:{min:0}}},h=new google.visualization.ColumnChart(document.getElementById("labels-distribution-chart"));h.draw(f,g)}function setStrategy(a){$("#al-strategy-name").text(a)}function setClassifier(a){$("#classifier-name").text(a)}function initializeMap(){return L.mapbox.tileLayer("mapbox.streets").addTo(map),map}function createLayerStyle(a,b){var c={color:a,weight:b,opacity:.6,fillOpacity:.2,fillColor:a};return c}function refreshLayers(){clearAllLayers();var a=[],b=[];for(var c in trajectories_map){var d=trajectories_map[c].label;"unlabeled"==d?a.push(trajectories_map[c]):(b.hasOwnProperty(d)||(b[d]=[]),b[d].push(trajectories_map[c]))}group_unlabeled_geojson_trajectories=insertTrajectoriesInMap(a,group_unlabeled_geojson_trajectories);for(var c in b){var e=$("#color-"+c).val(),f={color:e,weight:3};group_labeled_geojson_trajectories[c]=insertTrajectoriesInMap(b[c],group_labeled_geojson_trajectories[c]),group_labeled_geojson_trajectories[c].setStyle(f)}group_unlabeled_geojson_trajectories.bringToBack()}function clearAllLayers(){group_labeled_geojson_trajectories=[],map.eachLayer(function(a){map.removeLayer(a)}),map=initializeMap()}function setDefaults(){clearAllLayers(),group_unlabeled_geojson_trajectories&&delete window.group_unlabeled_geojson_trajectories,delete window.group_labeled_geojson_trajectories,delete window.labeled_trajectories,delete window.trajectories_map,delete window.al_strategy,delete window.classifier,delete window.dataset,delete window.previous_remaining_from_budget,delete window.point_selected_from_pf_chart,group_labeled_geojson_trajectories=[],map_label_index={},nextIndex=0,labeled_trajectories=[],feat_selector_list=[],$("#labels-colors").empty(),$("#add-new-label").prop("disabled",!0),$("#bag-component").remove(),disableRunButton(),disableNextAndAddButtons(),$("#label-selector").find("option").remove().end(),total_bound=0,first_time=!0,$("#results-nav").hide(),$("#bottom-nav").show()}function loadDataset(a){setDefaults(),$("#feats").remove(),readGeojsonData("/data/"+a)}function showLoadingAnimation(){$("#map").hide(),$("#loading").addClass("loading-show")}function hideLoadingAnimation(){$("#loading").removeClass("loading-show"),$("#map").show()}function readGeojsonData(a){group_unlabeled_geojson_trajectories&&group_unlabeled_geojson_trajectories.clearLayers(),jQuery.isEmptyObject(group_labeled_geojson_trajectories)&&group_labeled_geojson_trajectories.forEach(function(a,b,c){group_labeled_geojson_trajectories[b].clearLayers()}),showLoadingAnimation(),$.get(web_server_address+a,function(a){var b=a.split("\n");trajectories_map=[],unlabeled_items_key=[],b.forEach(function(a,b,c){if(a){var d=JSON.parse(a);trajectories_map[d.tid]=createGeojsonTrajectory(d,line_layer_default_style),trajectories_map[d.tid].label="unlabeled",unlabeled_items_key.push(d.tid)}}),refreshLayers(),$("#add-new-label").hasClass("btn-danger")&&$("#add-new-label").toggleClass("btn-danger btn-success"),$("#add-new-label").prop("disabled",!1);var c="Please add at least two class labels in the Manage labels panel";setNextStepMessage(c),hideLoadingAnimation(),setTopMessage("Dataset loaded with success!","success"),updateMapBounds(),nextStepBlinking("#add-new-label")})}function insertTrajectoriesInMap(a,b){return b=L.featureGroup(a),b.addTo(map),b}function updateMapBounds(){for(key in trajectories_map)if(group=trajectories_map[key],"undefined"==typeof total_bound||0==total_bound)total_bound=group.getBounds(),map.fitBounds(total_bound);else{var a=total_bound.extend(group.getBounds());map.fitBounds(a)}}function createGeojsonTrajectory(a,b){var c=L.geoJson(a,b);return c.on("click",function(a){var b;if("undefined"==typeof a.layer){var c=a.target._layers;for(key in c)b=c[key]}else b=a.layer;var d=L.featureGroup([this]);d.addTo(map),map.hasLayer(point_selected_from_pf_chart)&&map.removeLayer(point_selected_from_pf_chart),selected_layer=b,showTrajectoryFeatures(b),showPointFeatures(b),map.fitBounds(d.getBounds())}),c}function createLineStringWithGradients(a,b){line_lat_lon_seq=[];for(var c=a.geometry.coordinates,d=0;d<c.length;d++){var e=L.latLng(c[d][1],c[d][0]);pf_object={};for(pf_name in a.points)pf_object[pf_name]=a.points[pf_name][d];e.meta=pf_object,line_lat_lon_seq.push(e)}var f=(line_lat_lon_seq.length,L.multiOptionsPolyline(line_lat_lon_seq,{multiOptions:{optionIdxFn:function(a){var c,d=[],e=(this.max[b]-this.min[b])/9,f=(this.min[b]+e)/2;d.push(f);for(var g=1;g<9;g++)f+=e,d.push(f);for(c=0;c<d.length;++c)if(a.meta[b]<=d[c])return c;return d.length},options:[{color:"#ffe5e5"},{color:"#ffcccc"},{color:"#ffb2b2"},{color:"#ff9999"},{color:"#ff7f7f"},{color:"#ff6666"},{color:"#ff4c4c"},{color:"#ff3232"},{color:"#ff1919"},{color:"#FF0000"}]},weight:5,opacity:1,fillOpacity:1}));"undefined"!=typeof selected_trajectory_color_gradient&&map.removeLayer(selected_trajectory_color_gradient),selected_trajectory_color_gradient=f,f.addTo(map),"undefined"!=typeof selected_trajectory_arrows&&map.removeLayer(selected_trajectory_arrows);var g=L.polyline(line_lat_lon_seq,{}),h=L.polylineDecorator(g,{patterns:[{offset:0,repeat:"10%",symbol:L.Symbol.arrowHead({pixelSize:12,polygon:!1,pathOptions:{stroke:!0,color:"#FF0000",weight:3}})}]});selected_trajectory_arrows=h,h.addTo(map);var i=0;window.setInterval(function(){h.setPatterns([{offset:i+"%",repeat:"10%",symbol:L.Symbol.arrowHead({pixelSize:12,polygon:!1,pathOptions:{stroke:!0,color:"#FF0000",weight:3}})}]),++i>20&&(i=0)},200)}function unselectTrajectory(a){a.options.fillOpacity=.2,a.options.weight=3,a.setStyle(a.options)}function showPointFeatures(a){var b=a.feature.points,c=Object.keys(b);$("#point-feature-selector").show(),$("#point-feature-selector").empty();for(var d=0;d<c.length;d++){var e=c[d];$("#point-feature-selector").append("<option val='"+e+"'>"+e+"</option>")}$("#point-feature-selector").unbind(),$("#point-feature-selector").on("change",function(){var c=$("#point-feature-selector option:selected").text();$("#point-feat-line-chart").empty(),google.charts.setOnLoadCallback(drawPointFeatures(b,c)),createLineStringWithGradients(a.feature,c)}),google.charts.setOnLoadCallback(drawPointFeatures(b,e)),createLineStringWithGradients(a.feature,e)}function drawPointFeatures(a,b){var c=[];pf_chart={},c.push(["PID","Value"]),a[b].forEach(function(a,b,d){c.push([b,a])});var d=google.visualization.arrayToDataTable(c),e={height:190,titleTextStyle:{fontSize:16,bold:!0},colors:["red"],legend:{position:"none"},hAxis:{title:"PID"},vAxis:{title:"Value"}};pf_chart=new google.visualization.LineChart(document.getElementById("point-feat-line-chart")),pf_chart.draw(d,e),google.visualization.events.addListener(pf_chart,"select",selectPID)}function selectPID(){map.hasLayer(point_selected_from_pf_chart)&&map.removeLayer(point_selected_from_pf_chart);var a=pf_chart.getSelection()[0].row,b=line_lat_lon_seq[a],c=L.icon({iconUrl:"/images/pin.png",iconSize:[25,50],iconAnchor:[13,50]});point_selected_from_pf_chart=L.marker(b,{icon:c}),point_selected_from_pf_chart.addTo(map)}function showTrajectoryFeatures(a){var b=$("#features-tbl");b.empty(),b.append("<dl id='tid' tid_val="+a.feature.tid+' class="inline dl-no-margin">tid: <dt>'+a.feature.tid+"</dt></dl>");for(var c in a.feature.properties)b.append('<dl class="inline dl-no-margin">'+c+": <dt>"+trunc(a.feature.properties[c])+"</dt></dl>")}function trunc(a){return Math.floor(100*a)/100}$("#add-new-label").click(function(a){a.preventDefault();var b=$("#label-txt").val().split(" ").join("-");if(!b){var c="Error! Please add a name to the label.";return void setTopMessage(c,"error")}if(0==$("#label-selector option[val='"+b+"']").length){$("#label-selector").append("<option val='"+b+"'>"+b+"</option>"),$("#label-txt").val("");var c="Success! Label added to the list.";setTopMessage(c,"success"),$("#label-selector option").size()>=2&&(enableNextAndAddButtons(),setNextStepMessage("Please add a label of each class to a trajectory for starting running an Active Learning strategy."),nextStepBlinking("#next-trajectory"),nextStepBlinking("#add-label-to-trajectory"));var d=layer_colors[$("#label-selector option").size()-1],e="color-"+b,f="<input id="+e+' type="color" name="favcolor" value="'+d+'">',g='<input type="checkbox" id="checkbox_'+b+'" checked>',h="weight-"+b,i="<select name="+h+" id="+h+">";i+="<option>1</option>",i+="<option>2</option>",i+='<option val="3">3</option>',i+="<option>4</option>",i+="<option>5</option>",i+="<option>6</option>",i+="<option>7</option>",i+="<option>8</option>",i+="<option>9</option>",i+="</select>";var j="<dl><b>"+b+":</b>"+f+"&nbsp;<b>Visible:</b>"+g+"&nbsp;<b>Weight:</b>"+i+"</dl>";$("#labels-colors").append(j),$("#"+h).val("3").change(),$("#"+e).change(function(){var a=createLayerStyle($("#"+e).val(),$("#"+h).val());group_labeled_geojson_trajectories[b].setStyle(a),$("#results-nav").is(":visible")&&createResultsCharts()}),$("#"+h).change(function(){var a=createLayerStyle($("#"+e).val(),$("#"+h).val());group_labeled_geojson_trajectories[b].setStyle(a)}),$("#checkbox_"+b).change(function(){$(this).is(":checked")?"undefined"!=typeof group_labeled_geojson_trajectories[b]&&group_labeled_geojson_trajectories[b].addTo(map):map.removeLayer(group_labeled_geojson_trajectories[b])})}else{var c="Error! Label <u>"+b+"</u> is already in the list.";setTopMessage(c,"error")}}),$("#run-button").click(function(){var a=parseInt($("#remaining-budget").text());$("#time-step").prop("disabled",!0),$("#total-budget").prop("disabled",!0);var b={};al_strategy?b.strategy=al_strategy:b.strategy="Random Sampling",classifier?b.classifier=classifier:b.classifier="Logistic Regression",b.dataset=dataset;var c=parseInt($("#remaining-budget").text()),d=parseInt($("#time-step").val());first_time?(b.time_step=d,first_time=!1):c-d>=0?b.time_step=d:b.time_step=c,b.labeled_trajectories=convertObjectMapToArray(labeled_trajectories),b=JSON.stringify(b),0==a?(b.classify_all=!0,classifyAllData(b)):(b.classify_all=!1,runActiveLearning(b))}),$("#unlabeled-color").change(function(){var a=createLayerStyle($("#unlabeled-color").val(),3);group_unlabeled_geojson_trajectories.setStyle(a),group_unlabeled_geojson_trajectories.bringToBack()});var selected_item_key;$("#next-trajectory").click(function(a){a.preventDefault(),unlabeled_items_key=rotate(unlabeled_items_key,1),trajectories_map[unlabeled_items_key[0]].fire("click")}),$("#add-label-to-trajectory").click(function(a){a.preventDefault();var b=$("#tid")[0].attributes.tid_val.value,c=$("#label-selector option:selected").text(),d={};map_label_index.hasOwnProperty(c)||(map_label_index[c]=nextIndex,nextIndex++),d.tid=Number(b),d.label_value=c,labeled_trajectories[b]=d;var e=createLayerStyle($("#color-"+c).val(),3);trajectories_map[d.tid].label=c,refreshLayers(),group_labeled_geojson_trajectories[c].setStyle(e);var f=Object.keys(labeled_trajectories).length;$("#total-labeled").text(f),nextIndex>1&&first_time&&(disableNextAndAddButtons(),enableRunButton(),setNextStepMessage("Click on the Run button in the Active Learning panel to start."),nextStepBlinking("#run-button")),updateSummary();var g="Label <b>"+c+"</b> succesfully added to trajectory id (tid) <b>"+b+"</b>",h=previous_remaining_from_budget-parseInt($("#time-step").val()),i=parseInt($("#remaining-budget").text());return first_time?($("#next-trajectory").click(),void setTopMessage(g,"success")):(h==parseInt($("#remaining-budget").text())?(disableNextAndAddButtons(),enableRunButton(),setNextStepMessage("Click on the Run button in the Active Learning panel to run the selected strategy."),nextStepBlinking("#run-button"),updateMapBounds()):0==i?(disableNextAndAddButtons(),enableRunButton(),setNextStepMessage("Click on the Run button to classify all trajectories."),nextStepBlinking("#run-button"),updateMapBounds()):$("#next-trajectory").click(),setTopMessage(g,"success"),0)}),google.charts.load("current",{packages:["corechart","bar"]});var values_by_label_and_feature=[];$(window).resize(function(){labeled_trajectories.length>1&&(createResultsCharts(),showPointFeatures(selected_layer))}),$("#rnd").click(function(){al_strategy="Random Sampling",setStrategy(al_strategy)}),$("#unc").click(function(){al_strategy="Uncertain Sampling",setStrategy(al_strategy)}),$("#qbc").click(function(){al_strategy="Query-by-committee",setStrategy(al_strategy)}),$("#lr").click(function(){classifier="Logistic Regression",setClassifier(classifier)}),$("#gnb").click(function(){classifier="Gaussian Naive Bayes",setClassifier(classifier)}),$("#dt").click(function(){classifier="Decision Tree",setClassifier(classifier)}),$("#knn").click(function(){classifier="KNN",setClassifier(classifier)}),$("#ab").click(function(){classifier="Ada Boost",setClassifier(classifier)}),$("#rf").click(function(){classifier="Random Forest",setClassifier(classifier)}),$("#fishing").click(function(){dataset="fishingvessels",loadDataset(dataset)}),$("#geolife").click(function(){dataset="geolife",loadDataset(dataset)}),$("#hurricanes").click(function(){dataset="hurricanes",loadDataset(dataset)}),$("#animals").click(function(){dataset="animals",loadDataset(dataset)}),nextStepBlinking("#load-data");var trajectories_map,al_strategy,classifier,dataset,group_unlabeled_geojson_trajectories,previous_remaining_from_budget,total_bound=0,first_time=!0,group_labeled_geojson_trajectories=[],unlabeled_items_key=[],bag_of_trajectories={},point_selected_from_pf_chart,pf_chart={},line_lat_lon_seq,selected_trajectory_color_gradient,selected_trajectory_arrows,box_message_on_map,map_label_index={},nextIndex=0,labeled_trajectories=[],web_server_address="http://206.167.183.217:80",default_unlabeled_color="#FF0000",line_layer_default_style=createLayerStyle(default_unlabeled_color,3),layer_colors=[];layer_colors.push("#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF"),L.mapbox.accessToken="pk.eyJ1IjoiYW1pbGNhcnNqIiwiYSI6ImNpdHAyODc2cDAwM2ozM21vZGQwMnUxNmYifQ.kxDj2-uHVNpfIuZVuJ-1FQ";var options={minZoom:2,maxZoom:15},map=L.mapbox.map("map","mapbox.streets",options).setView([0,0],2);map=initializeMap(),$("#results-nav").hide(),setNextStepMessage("Please select a database!"),window.File&&window.FileReader&&window.FileList&&window.Blob||alert("The File APIs are not fully supported in this browser.");var selected_layer;!function(){"use strict";L.MultiOptionsPolyline=L.FeatureGroup.extend({_getMin:function(a){var b={};for(key in a[0].meta)a.forEach(function(a,c,d){"undefined"==typeof b[key]?b[key]=a.meta[key]:a.meta[key]<b[key]&&(b[key]=a.meta[key])});this.min=b},_getMax:function(a){var b={};for(key in a[0].meta)a.forEach(function(a,c,d){"undefined"==typeof b[key]?b[key]=a.meta[key]:a.meta[key]>b[key]&&(b[key]=a.meta[key])});this.max=b},initialize:function(a,b){var c=b.multiOptions.copyBaseOptions;this._layers={},this._options=b,(void 0===c||c)&&this._copyBaseOptions(),this._getMin(a),this._getMax(a),this.setLatLngs(a)},_copyBaseOptions:function(){var a,b,c=this._options.multiOptions,d=c.options,e=d.length;for(a=L.extend({},this._options),delete a.multiOptions,b=0;b<e;++b)d[b]=L.extend({},a,d[b])},setLatLngs:function(a){var b,c,d,e,f=a.length,g=this._options.multiOptions,h=g.optionIdxFn,i=g.fnContext||this;for(this._originalLatlngs=a,this.eachLayer(function(a){this.removeLayer(a)},this),b=1;b<f;++b)d=h.call(i,a[b],a[b-1],b,a),1===b&&(e=[a[0]],c=h.call(i,a[0],a[0],0,a)),e.push(a[b]),c===d&&b!==f-1||("function"==typeof g.options?this.addLayer(new L.Polyline(e,g.options(c))):this.addLayer(new L.Polyline(e,g.options[c])),c=d,e=[a[b]]);return this},getLatLngs:function(){return this._originalLatlngs},getLatLngsSegments:function(){var a=[];return this.eachLayer(function(b){a.push(b.getLatLngs())}),a}}),L.multiOptionsPolyline=function(a,b){return new L.MultiOptionsPolyline(a,b)}}(),L.LineUtil.PolylineDecorator={computeAngle:function(a,b){return 180*Math.atan2(b.y-a.y,b.x-a.x)/Math.PI+90},getPointPathPixelLength:function(a){var b=a.length;if(b<2)return 0;for(var c,d=0,e=a[0],f=1;f<b;f++)d+=e.distanceTo(c=a[f]),e=c;return d},getPixelLength:function(a,b){var c=a instanceof L.Polyline?a.getLatLngs():a,d=c.length;if(d<2)return 0;for(var e,f=0,g=b.project(c[0]),h=1;h<d;h++)f+=g.distanceTo(e=b.project(c[h])),g=e;return f},projectPatternOnPath:function(a,b,c,d,e){var f,g=[];for(f=0,l=a.length;f<l;f++)g[f]=e.project(a[f]);var h=this.projectPatternOnPointPath(g,b,c,d);for(f=0,l=h.length;f<l;f++)h[f].latLng=e.unproject(h[f].pt);return h},projectPatternOnPointPath:function(a,b,c,d){var e=[],f=this.getPointPathPixelLength(a)*d,g=this.interpolateOnPointPath(a,b),h=c>0?this.getPointPathPixelLength(a)*c:0;if(e.push(g),d>0){var i=a;i=i.slice(g.predecessor),i[0]=g.pt;for(var j=this.getPointPathPixelLength(i);f<=j-h;)g=this.interpolateOnPointPath(i,f/j),e.push(g),i=i.slice(g.predecessor),i[0]=g.pt,j=this.getPointPathPixelLength(i)}return e},interpolateOnPointPath:function(a,b){var c=a.length;if(c<2)return null;if(b<=0)return{pt:a[0],predecessor:0,heading:this.computeAngle(a[0],a[1])};if(b>=1)return{pt:a[c-1],predecessor:c-1,heading:this.computeAngle(a[c-2],a[c-1])};if(2==c)return{pt:this.interpolateBetweenPoints(a[0],a[1],b),predecessor:0,heading:this.computeAngle(a[0],a[1])};for(var d=this.getPointPathPixelLength(a),e=a[0],f=e,g=0,h=0,i=0,j=1;j<c&&h<b;j++)e=f,g=h,f=a[j],i+=e.distanceTo(f),h=i/d;var k=(b-g)/(h-g);return{pt:this.interpolateBetweenPoints(e,f,k),predecessor:j-2,heading:this.computeAngle(e,f)}},interpolateBetweenPoints:function(a,b,c){return b.x!=a.x?new L.Point(a.x*(1-c)+c*b.x,a.y*(1-c)+c*b.y):new L.Point(a.x,a.y+(b.y-a.y)*c)}},L.PolylineDecorator=L.FeatureGroup.extend({options:{patterns:[]},initialize:function(a,b){L.FeatureGroup.prototype.initialize.call(this),L.Util.setOptions(this,b),this._map=null,this._initPaths(a),this._initPatterns()},_initPaths:function(a){this._paths=[];if(a instanceof L.Polyline)this._initPath(a.getLatLngs(),a instanceof L.Polygon);else if(L.Util.isArray(a)&&a.length>0)if(a[0]instanceof L.Polyline)for(var b=0;b<a.length;b++)this._initPath(a[b].getLatLngs(),a[b]instanceof L.Polygon);else this._initPath(a)},_isCoordArray:function(a){return L.Util.isArray(a)&&a.length>0&&(a[0]instanceof L.LatLng||L.Util.isArray(a[0])&&2==a[0].length&&"number"==typeof a[0][0])},_initPath:function(a,b){var c;c=this._isCoordArray(a)?[a]:a;for(var d=0;d<c.length;d++)b&&c[d].push(c[d][0]),this._paths.push(c[d])},_initPatterns:function(){this._isZoomDependant=!1,this._patterns=[];for(var a,b=0;b<this.options.patterns.length;b++)a=this._parsePatternDef(this.options.patterns[b]),this._patterns.push(a),this._isZoomDependant=this._isZoomDependant||a.isOffsetInPixels||a.isEndOffsetInPixels||a.isRepeatInPixels||a.symbolFactory.isZoomDependant},setPatterns:function(a){this.options.patterns=a,this._initPatterns(),this._softRedraw()},setPaths:function(a){this._initPaths(a),this.redraw()},_parsePatternDef:function(a,b){var c={cache:[],symbolFactory:a.symbol,isOffsetInPixels:!1,isEndOffsetInPixels:!1,isRepeatInPixels:!1};return"string"==typeof a.offset&&a.offset.indexOf("%")!=-1?c.offset=parseFloat(a.offset)/100:(c.offset=a.offset?parseFloat(a.offset):0,c.isOffsetInPixels=c.offset>0),"string"==typeof a.endOffset&&a.endOffset.indexOf("%")!=-1?c.endOffset=parseFloat(a.endOffset)/100:(c.endOffset=a.endOffset?parseFloat(a.endOffset):0,c.isEndOffsetInPixels=c.endOffset>0),"string"==typeof a.repeat&&a.repeat.indexOf("%")!=-1?c.repeat=parseFloat(a.repeat)/100:(c.repeat=parseFloat(a.repeat),c.isRepeatInPixels=c.repeat>0),c},onAdd:function(a){this._map=a,this._draw(),this._isZoomDependant&&this._map.on("zoomend",this._softRedraw,this)},onRemove:function(a){this._map.off("zoomend",this._softRedraw,this),this._map=null,L.LayerGroup.prototype.onRemove.call(this,a)},_buildSymbols:function(a,b,c){for(var d=[],e=0,f=c.length;e<f;e++)d.push(b.buildSymbol(c[e],a,this._map,e,f));return d},_getCache:function(a,b,c){var d=a.cache[b];return"undefined"==typeof d?(a.cache[b]=[],null):d[c]},_getDirectionPoints:function(a,b){var c=this._map.getZoom(),d=this._getCache(b,c,a);if(d)return d;var e,f,g,h=null,i=this._paths[a];return b.isOffsetInPixels?(h=L.LineUtil.PolylineDecorator.getPixelLength(i,this._map),e=b.offset/h):e=b.offset,b.isEndOffsetInPixels?(h=null!==h?h:L.LineUtil.PolylineDecorator.getPixelLength(i,this._map),f=b.endOffset/h):f=b.endOffset,b.isRepeatInPixels?(h=null!==h?h:L.LineUtil.PolylineDecorator.getPixelLength(i,this._map),g=b.repeat/h):g=b.repeat,d=L.LineUtil.PolylineDecorator.projectPatternOnPath(i,e,f,g,this._map),b.cache[c][a]=d,d},redraw:function(){this._redraw(!0)},_softRedraw:function(){this._redraw(!1)},_redraw:function(a){if(null!==this._map){if(this.clearLayers(),a)for(var b=0;b<this._patterns.length;b++)this._patterns[b].cache=[];this._draw()}},_drawPattern:function(a){for(var b,c,d=0;d<this._paths.length;d++){b=this._getDirectionPoints(d,a),c=this._buildSymbols(this._paths[d],a.symbolFactory,b);for(var e=0;e<c.length;e++)this.addLayer(c[e])}},_draw:function(){for(var a=0;a<this._patterns.length;a++)this._drawPattern(this._patterns[a])}}),L.polylineDecorator=function(a,b){return new L.PolylineDecorator(a,b)},L.RotatedMarker=L.Marker.extend({options:{angle:0},statics:{TRANSFORM_ORIGIN:L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"])},_initIcon:function(){L.Marker.prototype._initIcon.call(this),this._icon.style[L.RotatedMarker.TRANSFORM_ORIGIN]=this._getTransformOrigin()},_getTransformOrigin:function(){var a=this.options.icon.options.iconAnchor;return a?a[0]+"px "+a[1]+"px":"50% 50%"},_setPos:function(a){if(L.Marker.prototype._setPos.call(this,a),L.DomUtil.TRANSFORM)this._icon.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var b=this.options.angle*(Math.PI/180),c=Math.cos(b),d=Math.sin(b);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+c+", M12="+-d+", M21="+d+", M22="+c+")"}},setAngle:function(a){this.options.angle=a}}),L.rotatedMarker=function(a,b){return new L.RotatedMarker(a,b)},L.Symbol=L.Symbol||{},L.Symbol.Dash=L.Class.extend({isZoomDependant:!0,options:{pixelSize:10,pathOptions:{}},initialize:function(a){L.Util.setOptions(this,a),this.options.pathOptions.clickable=!1},buildSymbol:function(a,b,c,d,e){var f=this.options,g=Math.PI/180;if(f.pixelSize<=1)return new L.Polyline([a.latLng,a.latLng],f.pathOptions);var h=c.project(a.latLng),i=-(a.heading-90)*g,j=new L.Point(h.x+f.pixelSize*Math.cos(i+Math.PI)/2,h.y+f.pixelSize*Math.sin(i)/2),k=h.add(h.subtract(j));return new L.Polyline([c.unproject(j),c.unproject(k)],f.pathOptions)}}),L.Symbol.dash=function(a){return new L.Symbol.Dash(a)},L.Symbol.ArrowHead=L.Class.extend({isZoomDependant:!0,options:{polygon:!0,pixelSize:10,headAngle:60,pathOptions:{stroke:!1,weight:2}},initialize:function(a){L.Util.setOptions(this,a),this.options.pathOptions.clickable=!1},buildSymbol:function(a,b,c,d,e){var f,g=this.options;return f=g.polygon?new L.Polygon(this._buildArrowPath(a,c),g.pathOptions):new L.Polyline(this._buildArrowPath(a,c),g.pathOptions)},_buildArrowPath:function(a,b){var c=Math.PI/180,d=b.project(a.latLng),e=-(a.heading-90)*c,f=this.options.headAngle/2*c,g=e+f,h=e-f,i=new L.Point(d.x-this.options.pixelSize*Math.cos(g),d.y+this.options.pixelSize*Math.sin(g)),j=new L.Point(d.x-this.options.pixelSize*Math.cos(h),d.y+this.options.pixelSize*Math.sin(h));
return[b.unproject(i),a.latLng,b.unproject(j)]}}),L.Symbol.arrowHead=function(a){return new L.Symbol.ArrowHead(a)},L.Symbol.Marker=L.Class.extend({isZoomDependant:!1,options:{markerOptions:{},rotate:!1},initialize:function(a){L.Util.setOptions(this,a),this.options.markerOptions.clickable=!1,this.options.markerOptions.draggable=!1,this.isZoomDependant=L.Browser.ie&&this.options.rotate},buildSymbol:function(a,b,c,d,e){return this.options.rotate?(this.options.markerOptions.angle=a.heading+(this.options.angleCorrection||0),new L.RotatedMarker(a.latLng,this.options.markerOptions)):new L.Marker(a.latLng,this.options.markerOptions)}}),L.Symbol.marker=function(a){return new L.Symbol.Marker(a)},L.LineUtil.PolylineDecorator={computeAngle:function(a,b){return 180*Math.atan2(b.y-a.y,b.x-a.x)/Math.PI+90},getPointPathPixelLength:function(a){var b=a.length;if(b<2)return 0;for(var c,d=0,e=a[0],f=1;f<b;f++)d+=e.distanceTo(c=a[f]),e=c;return d},getPixelLength:function(a,b){var c=a instanceof L.Polyline?a.getLatLngs():a,d=c.length;if(d<2)return 0;for(var e,f=0,g=b.project(c[0]),h=1;h<d;h++)f+=g.distanceTo(e=b.project(c[h])),g=e;return f},projectPatternOnPath:function(a,b,c,d,e){var f,g=[];for(f=0,l=a.length;f<l;f++)g[f]=e.project(a[f]);var h=this.projectPatternOnPointPath(g,b,c,d);for(f=0,l=h.length;f<l;f++)h[f].latLng=e.unproject(h[f].pt);return h},projectPatternOnPointPath:function(a,b,c,d){var e=[],f=this.getPointPathPixelLength(a)*d,g=this.interpolateOnPointPath(a,b),h=c>0?this.getPointPathPixelLength(a)*c:0;if(e.push(g),d>0){var i=a;i=i.slice(g.predecessor),i[0]=g.pt;for(var j=this.getPointPathPixelLength(i);f<=j-h;)g=this.interpolateOnPointPath(i,f/j),e.push(g),i=i.slice(g.predecessor),i[0]=g.pt,j=this.getPointPathPixelLength(i)}return e},interpolateOnPointPath:function(a,b){var c=a.length;if(c<2)return null;if(b<=0)return{pt:a[0],predecessor:0,heading:this.computeAngle(a[0],a[1])};if(b>=1)return{pt:a[c-1],predecessor:c-1,heading:this.computeAngle(a[c-2],a[c-1])};if(2==c)return{pt:this.interpolateBetweenPoints(a[0],a[1],b),predecessor:0,heading:this.computeAngle(a[0],a[1])};for(var d=this.getPointPathPixelLength(a),e=a[0],f=e,g=0,h=0,i=0,j=1;j<c&&h<b;j++)e=f,g=h,f=a[j],i+=e.distanceTo(f),h=i/d;var k=(b-g)/(h-g);return{pt:this.interpolateBetweenPoints(e,f,k),predecessor:j-2,heading:this.computeAngle(e,f)}},interpolateBetweenPoints:function(a,b,c){return b.x!=a.x?new L.Point(a.x*(1-c)+c*b.x,a.y*(1-c)+c*b.y):new L.Point(a.x,a.y+(b.y-a.y)*c)}},L.PolylineDecorator=L.FeatureGroup.extend({options:{patterns:[]},initialize:function(a,b){L.FeatureGroup.prototype.initialize.call(this),L.Util.setOptions(this,b),this._map=null,this._initPaths(a),this._initPatterns()},_initPaths:function(a){this._paths=[];if(a instanceof L.Polyline)this._initPath(a.getLatLngs(),a instanceof L.Polygon);else if(L.Util.isArray(a)&&a.length>0)if(a[0]instanceof L.Polyline)for(var b=0;b<a.length;b++)this._initPath(a[b].getLatLngs(),a[b]instanceof L.Polygon);else this._initPath(a)},_isCoordArray:function(a){return L.Util.isArray(a)&&a.length>0&&(a[0]instanceof L.LatLng||L.Util.isArray(a[0])&&2==a[0].length&&"number"==typeof a[0][0])},_initPath:function(a,b){var c;c=this._isCoordArray(a)?[a]:a;for(var d=0;d<c.length;d++)b&&c[d].push(c[d][0]),this._paths.push(c[d])},_initPatterns:function(){this._isZoomDependant=!1,this._patterns=[];for(var a,b=0;b<this.options.patterns.length;b++)a=this._parsePatternDef(this.options.patterns[b]),this._patterns.push(a),this._isZoomDependant=this._isZoomDependant||a.isOffsetInPixels||a.isEndOffsetInPixels||a.isRepeatInPixels||a.symbolFactory.isZoomDependant},setPatterns:function(a){this.options.patterns=a,this._initPatterns(),this._softRedraw()},setPaths:function(a){this._initPaths(a),this.redraw()},_parsePatternDef:function(a,b){var c={cache:[],symbolFactory:a.symbol,isOffsetInPixels:!1,isEndOffsetInPixels:!1,isRepeatInPixels:!1};return"string"==typeof a.offset&&a.offset.indexOf("%")!=-1?c.offset=parseFloat(a.offset)/100:(c.offset=a.offset?parseFloat(a.offset):0,c.isOffsetInPixels=c.offset>0),"string"==typeof a.endOffset&&a.endOffset.indexOf("%")!=-1?c.endOffset=parseFloat(a.endOffset)/100:(c.endOffset=a.endOffset?parseFloat(a.endOffset):0,c.isEndOffsetInPixels=c.endOffset>0),"string"==typeof a.repeat&&a.repeat.indexOf("%")!=-1?c.repeat=parseFloat(a.repeat)/100:(c.repeat=parseFloat(a.repeat),c.isRepeatInPixels=c.repeat>0),c},onAdd:function(a){this._map=a,this._draw(),this._isZoomDependant&&this._map.on("zoomend",this._softRedraw,this)},onRemove:function(a){this._map.off("zoomend",this._softRedraw,this),this._map=null,L.LayerGroup.prototype.onRemove.call(this,a)},_buildSymbols:function(a,b,c){for(var d=[],e=0,f=c.length;e<f;e++)d.push(b.buildSymbol(c[e],a,this._map,e,f));return d},_getCache:function(a,b,c){var d=a.cache[b];return"undefined"==typeof d?(a.cache[b]=[],null):d[c]},_getDirectionPoints:function(a,b){var c=this._map.getZoom(),d=this._getCache(b,c,a);if(d)return d;var e,f,g,h=null,i=this._paths[a];return b.isOffsetInPixels?(h=L.LineUtil.PolylineDecorator.getPixelLength(i,this._map),e=b.offset/h):e=b.offset,b.isEndOffsetInPixels?(h=null!==h?h:L.LineUtil.PolylineDecorator.getPixelLength(i,this._map),f=b.endOffset/h):f=b.endOffset,b.isRepeatInPixels?(h=null!==h?h:L.LineUtil.PolylineDecorator.getPixelLength(i,this._map),g=b.repeat/h):g=b.repeat,d=L.LineUtil.PolylineDecorator.projectPatternOnPath(i,e,f,g,this._map),b.cache[c][a]=d,d},redraw:function(){this._redraw(!0)},_softRedraw:function(){this._redraw(!1)},_redraw:function(a){if(null!==this._map){if(this.clearLayers(),a)for(var b=0;b<this._patterns.length;b++)this._patterns[b].cache=[];this._draw()}},_drawPattern:function(a){for(var b,c,d=0;d<this._paths.length;d++){b=this._getDirectionPoints(d,a),c=this._buildSymbols(this._paths[d],a.symbolFactory,b);for(var e=0;e<c.length;e++)this.addLayer(c[e])}},_draw:function(){for(var a=0;a<this._patterns.length;a++)this._drawPattern(this._patterns[a])}}),L.polylineDecorator=function(a,b){return new L.PolylineDecorator(a,b)},L.RotatedMarker=L.Marker.extend({options:{angle:0},statics:{TRANSFORM_ORIGIN:L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"])},_initIcon:function(){L.Marker.prototype._initIcon.call(this),this._icon.style[L.RotatedMarker.TRANSFORM_ORIGIN]=this._getTransformOrigin()},_getTransformOrigin:function(){var a=this.options.icon.options.iconAnchor;return a?a[0]+"px "+a[1]+"px":"50% 50%"},_setPos:function(a){if(L.Marker.prototype._setPos.call(this,a),L.DomUtil.TRANSFORM)this._icon.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var b=this.options.angle*(Math.PI/180),c=Math.cos(b),d=Math.sin(b);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+c+", M12="+-d+", M21="+d+", M22="+c+")"}},setAngle:function(a){this.options.angle=a}}),L.rotatedMarker=function(a,b){return new L.RotatedMarker(a,b)},L.Symbol=L.Symbol||{},L.Symbol.Dash=L.Class.extend({isZoomDependant:!0,options:{pixelSize:10,pathOptions:{}},initialize:function(a){L.Util.setOptions(this,a),this.options.pathOptions.clickable=!1},buildSymbol:function(a,b,c,d,e){var f=this.options,g=Math.PI/180;if(f.pixelSize<=1)return new L.Polyline([a.latLng,a.latLng],f.pathOptions);var h=c.project(a.latLng),i=-(a.heading-90)*g,j=new L.Point(h.x+f.pixelSize*Math.cos(i+Math.PI)/2,h.y+f.pixelSize*Math.sin(i)/2),k=h.add(h.subtract(j));return new L.Polyline([c.unproject(j),c.unproject(k)],f.pathOptions)}}),L.Symbol.dash=function(a){return new L.Symbol.Dash(a)},L.Symbol.ArrowHead=L.Class.extend({isZoomDependant:!0,options:{polygon:!0,pixelSize:10,headAngle:60,pathOptions:{stroke:!1,weight:2}},initialize:function(a){L.Util.setOptions(this,a),this.options.pathOptions.clickable=!1},buildSymbol:function(a,b,c,d,e){var f,g=this.options;return f=g.polygon?new L.Polygon(this._buildArrowPath(a,c),g.pathOptions):new L.Polyline(this._buildArrowPath(a,c),g.pathOptions)},_buildArrowPath:function(a,b){var c=Math.PI/180,d=b.project(a.latLng),e=-(a.heading-90)*c,f=this.options.headAngle/2*c,g=e+f,h=e-f,i=new L.Point(d.x-this.options.pixelSize*Math.cos(g),d.y+this.options.pixelSize*Math.sin(g)),j=new L.Point(d.x-this.options.pixelSize*Math.cos(h),d.y+this.options.pixelSize*Math.sin(h));return[b.unproject(i),a.latLng,b.unproject(j)]}}),L.Symbol.arrowHead=function(a){return new L.Symbol.ArrowHead(a)},L.Symbol.Marker=L.Class.extend({isZoomDependant:!1,options:{markerOptions:{},rotate:!1},initialize:function(a){L.Util.setOptions(this,a),this.options.markerOptions.clickable=!1,this.options.markerOptions.draggable=!1,this.isZoomDependant=L.Browser.ie&&this.options.rotate},buildSymbol:function(a,b,c,d,e){return this.options.rotate?(this.options.markerOptions.angle=a.heading+(this.options.angleCorrection||0),new L.RotatedMarker(a.latLng,this.options.markerOptions)):new L.Marker(a.latLng,this.options.markerOptions)}}),L.Symbol.marker=function(a){return new L.Symbol.Marker(a)},function(){function a(a){a.Control.Loading=a.Control.extend({options:{delayIndicator:null,position:"topleft",separate:!1,zoomControl:null,spinjs:!1,spin:{lines:7,length:3,width:3,radius:5,rotate:13,top:"83%"}},initialize:function(b){a.setOptions(this,b),this._dataLoaders={},null!==this.options.zoomControl&&(this.zoomControl=this.options.zoomControl)},onAdd:function(c){if(this.options.spinjs&&"function"!=typeof Spinner)return b.error("Leaflet.loading cannot load because you didn't load spin.js (http://fgnass.github.io/spin.js/), even though you set it in options.");this._addLayerListeners(c),this._addMapListeners(c),this.options.separate||this.zoomControl||(c.zoomControl?this.zoomControl=c.zoomControl:c.zoomsliderControl&&(this.zoomControl=c.zoomsliderControl));var d,e="leaflet-control-loading";return this.zoomControl&&!this.options.separate?(d=this.zoomControl._container,e+=" leaflet-bar-part-bottom leaflet-bar-part last",a.DomUtil.addClass(this._getLastControlButton(),"leaflet-bar-part-bottom")):d=a.DomUtil.create("div","leaflet-control-zoom leaflet-bar"),this._indicator=a.DomUtil.create("a",e,d),this.options.spinjs&&(this._spinner=new Spinner(this.options.spin).spin(),this._indicator.appendChild(this._spinner.el)),d},onRemove:function(a){this._removeLayerListeners(a),this._removeMapListeners(a)},removeFrom:function(b){return this.zoomControl&&!this.options.separate?(this._container.removeChild(this._indicator),this._map=null,this.onRemove(b),this):a.Control.prototype.removeFrom.call(this,b)},addLoader:function(a){if(this._dataLoaders[a]=!0,this.options.delayIndicator&&!this.delayIndicatorTimeout){var b=this;this.delayIndicatorTimeout=setTimeout(function(){b.updateIndicator(),b.delayIndicatorTimeout=null},this.options.delayIndicator)}else this.updateIndicator()},removeLoader:function(a){delete this._dataLoaders[a],this.updateIndicator(),this.options.delayIndicator&&this.delayIndicatorTimeout&&!this.isLoading()&&(clearTimeout(this.delayIndicatorTimeout),this.delayIndicatorTimeout=null)},updateIndicator:function(){this.isLoading()?this._showIndicator():this._hideIndicator()},isLoading:function(){return this._countLoaders()>0},_countLoaders:function(){var a,b=0;for(a in this._dataLoaders)this._dataLoaders.hasOwnProperty(a)&&b++;return b},_showIndicator:function(){a.DomUtil.addClass(this._indicator,"is-loading"),this.options.separate||(this.zoomControl instanceof a.Control.Zoom?a.DomUtil.removeClass(this._getLastControlButton(),"leaflet-bar-part-bottom"):"function"==typeof a.Control.Zoomslider&&this.zoomControl instanceof a.Control.Zoomslider&&a.DomUtil.removeClass(this.zoomControl._ui.zoomOut,"leaflet-bar-part-bottom"))},_hideIndicator:function(){a.DomUtil.removeClass(this._indicator,"is-loading"),this.options.separate||(this.zoomControl instanceof a.Control.Zoom?a.DomUtil.addClass(this._getLastControlButton(),"leaflet-bar-part-bottom"):"function"==typeof a.Control.Zoomslider&&this.zoomControl instanceof a.Control.Zoomslider&&a.DomUtil.addClass(this.zoomControl._ui.zoomOut,"leaflet-bar-part-bottom"))},_getLastControlButton:function(){for(var a=this.zoomControl._container,b=a.children.length-1;b>0;){var c=a.children[b];if(this._indicator!==c&&0!==c.offsetWidth&&0!==c.offsetHeight)break;b--}return a.children[b]},_handleLoading:function(a){this.addLoader(this.getEventId(a))},_handleBaseLayerChange:function(b){var c=this;b.layer&&b.layer.eachLayer&&"function"==typeof b.layer.eachLayer?b.layer.eachLayer(function(a){c._handleBaseLayerChange({layer:a})}):a.TileLayer.Canvas&&b.layer instanceof a.TileLayer.Canvas||c._handleLoading(b)},_handleLoad:function(a){this.removeLoader(this.getEventId(a))},getEventId:function(a){return a.id?a.id:a.layer?a.layer._leaflet_id:a.target._leaflet_id},_layerAdd:function(a){if(a.layer&&a.layer.on)try{a.layer.on({loading:this._handleLoading,load:this._handleLoad},this)}catch(c){b.warn("L.Control.Loading: Tried and failed to add  event handlers to layer",a.layer),b.warn("L.Control.Loading: Full details",c)}},_layerRemove:function(a){if(a.layer&&a.layer.off)try{a.layer.off({loading:this._handleLoading,load:this._handleLoad},this)}catch(c){b.warn("L.Control.Loading: Tried and failed to remove event handlers from layer",a.layer),b.warn("L.Control.Loading: Full details",c)}},_addLayerListeners:function(a){a.eachLayer(function(a){a.on&&a.on({loading:this._handleLoading,load:this._handleLoad},this)},this),a.on("layeradd",this._layerAdd,this),a.on("layerremove",this._layerRemove,this)},_removeLayerListeners:function(a){a.eachLayer(function(a){a.off&&a.off({loading:this._handleLoading,load:this._handleLoad},this)},this),a.off("layeradd",this._layerAdd,this),a.off("layerremove",this._layerRemove,this)},_addMapListeners:function(a){a.on({baselayerchange:this._handleBaseLayerChange,dataloading:this._handleLoading,dataload:this._handleLoad,layerremove:this._handleLoad},this)},_removeMapListeners:function(a){a.off({baselayerchange:this._handleBaseLayerChange,dataloading:this._handleLoading,dataload:this._handleLoad,layerremove:this._handleLoad},this)}}),a.Map.addInitHook(function(){this.options.loadingControl&&(this.loadingControl=new a.Control.Loading,this.addControl(this.loadingControl))}),a.Control.loading=function(b){return new a.Control.Loading(b)}}var b=window.console||{error:function(){},warn:function(){}};"function"==typeof define&&define.amd?define(["leaflet"],function(b){a(b)}):a(L)}(),L.Control.Messagebox=L.Control.extend({options:{position:"topright",timeout:3e3},onAdd:function(a){return this._container=L.DomUtil.create("div","leaflet-control-messagebox"),this._container},show:function(a,b,c){var d=this._container;d.innerHTML=a,$(".leaflet-control-messagebox").addClass(c),d.style.display="block",d.style["font-size"]="16px",b=b||this.options.timeout,"number"==typeof this.timeoutID&&clearTimeout(this.timeoutID),this.timeoutID=setTimeout(function(){d.style.display="none"},b)}}),L.Map.mergeOptions({messagebox:!1}),L.Map.addInitHook(function(){this.options.messagebox&&(this.messagebox=new L.Control.Messagebox,this.addControl(this.messagebox))}),L.control.messagebox=function(a){return new L.Control.Messagebox(a)};